trigger:
  branches:
    include:
      - develop

pr:
  branches:
    include:
      - develop

variables:
  SONAR_SCANNER_VERSION: '4.8.0.2856'    # Use the variable for vmImage


stages:
  - stage: SecurityScans
    displayName: "Security Scans on PR"
    jobs:
      - job: GitleaksAndTrivy
        displayName: "Run Gitleaks + Trivy Scans"
        pool:
          name:    # Using hosted pool

        steps:
          - checkout: self
            fetchDepth: '0'

          # Setup Gitleaks
          - script: |
              echo "Downloading Gitleaks..."
              curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
              tar -xzf gitleaks.tar.gz
              ls -l   # check contents
              chmod +x gitleaks
              ./gitleaks version
            displayName: "Setup Gitleaks"

          # Run Gitleaks scan
          - script: |
              echo "Running Gitleaks..."
              ./gitleaks detect --source . --report-path gitleaks-report.json --exit-code 1
            displayName: "Run Gitleaks Scan"
            continueOnError: true   # Continue even if secrets found

          - task: PublishBuildArtifacts@1
            displayName: "Upload Gitleaks Report"
            inputs:
              PathtoPublish: gitleaks-report.json
              ArtifactName: gitleaks-report
              publishLocation: Container

          # Setup Trivy
          - script: |
              echo "Downloading Trivy..."
              wget -q https://github.com/aquasecurity/trivy/releases/download/v0.51.1/trivy_0.51.1_Linux-64bit.tar.gz
              tar -zxf trivy_0.51.1_Linux-64bit.tar.gz
              ls -l   # check contents
              chmod +x trivy
              ./trivy --version
            displayName: "Setup Trivy"

          # Run Trivy filesystem scan
          - script: |
              echo "Running Trivy filesystem scan..."
              ./trivy fs . --format table --output trivy-report.txt || true
            displayName: "Run Trivy Filesystem Scan"

          - task: PublishBuildArtifacts@1
            displayName: "Upload Trivy Report"
            inputs:
              PathtoPublish: trivy-report.txt
              ArtifactName: trivy-report
              publishLocation: Container

          # SonarQube Analysis
          - script: |
                      # Install SonarQube Scanner
                      wget -O /tmp/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$(SONAR_SCANNER_VERSION).zip
                      unzip /tmp/sonar-scanner.zip -d /tmp
                      export PATH=$PATH:/tmp/sonar-scanner-$(SONAR_SCANNER_VERSION)/bin
                      echo "Running SonarQube analysis..."
                      sonar-scanner \
                        -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
                        -Dsonar.javascript.node.maxspace=8192 \
                        -Dsonar.sources=. \
                        -Dsonar.host.url=$(SONAR_HOST_URL) \
                        -Dsonar.login=$(SONAR_TOKEN)
            displayName: "SonarQube Analysis"